<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×œ×•××“×™× ×œ×›×ª×•×‘ ××•×ª×™×•×ª ×¢×‘×¨×™×ª - ×¢× ×’×¨×™×¨×ª ××“×‘×§×•×ª</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&family=Suez+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #ff69b4; /* Hot Pink */
            --secondary-color: #ff1493; /* Deep Pink */
            --background-start: #fddb92; /* Light Yellow */
            --background-end: #d1fdff; /* Light Cyan */
            --text-light: #ffffff;
            --text-dark: #333;
            --border-radius: 15px;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Assistant', sans-serif;
            background: linear-gradient(135deg, var(--background-start) 0%, var(--background-end) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-dark);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-family: 'Suez One', serif;
            font-size: clamp(2rem, 5vw, 2.8rem);
            color: var(--secondary-color);
            text-shadow: 1px 1px 2px rgba(255,255,255,0.7);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: clamp(1rem, 3vw, 1.2rem);
            color: var(--text-dark);
            opacity: 0.8;
        }

        .letters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .letter-card {
            background: var(--text-light);
            border-radius: var(--border-radius);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            border: 3px solid transparent;
            position: relative;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            aspect-ratio: 1 / 1;
        }

        .letter-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: var(--primary-color);
        }

        .letter-card.selected {
            border-color: var(--secondary-color);
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .letter-display {
            font-size: clamp(2.5rem, 10vw, 4rem);
            font-weight: bold;
            font-family: 'Suez One', 'David', serif;
            color: var(--primary-color);
            line-height: 1;
        }
        
        .letter-name {
            font-size: 0.9rem;
            color: var(--text-dark);
            margin-top: 5px;
            opacity: 0.9;
        }

        .practice-area {
            background: white;
            border-radius: 20px;
            padding: clamp(15px, 4vw, 30px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }

        .practice-area.active {
            display: block;
        }

        .practice-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .canvas-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 20px auto;
            aspect-ratio: 1 / 1;
            border: 4px solid var(--secondary-color);
            border-radius: var(--border-radius);
            background-color: var(--primary-color);
            overflow: hidden;
        }

        .canvas-container.delete-mode {
            cursor: crosshair;
        }

        .canvas-container.drag-mode {
            cursor: move;
        }

        .canvas-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        #drawingCanvas { z-index: 5; }
        #stickerContainer { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .mode-switcher {
            display: flex;
            background-color: #eee;
            border-radius: 25px;
            padding: 5px;
        }
        
        .mode-btn {
            padding: 8px 16px;
            border: none;
            background-color: transparent;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .mode-btn.active {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn {
            background: linear-gradient(145deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .btn.delete-mode {
            background: linear-gradient(145deg, #ff4444, #cc0000);
        }

        .btn.delete-mode.active {
            background: linear-gradient(145deg, #cc0000, #ff4444);
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
        }

        .btn.drag-mode {
            background: linear-gradient(145deg, #007bff, #0056b3);
        }

        .btn.drag-mode.active {
            background: linear-gradient(145deg, #0056b3, #007bff);
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.5);
        }

        .instructions {
            text-align: center;
            color: #666;
            font-size: 1.1rem;
            margin-top: 20px;
            min-height: 2em;
        }

        .back-btn {
            background: linear-gradient(145deg, #6c757d, #495057);
            margin-bottom: 20px;
        }

        .palette {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .color-swatch, .sticker-swatch {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sticker-swatch { cursor: pointer; }
        
        .sticker-swatch svg {
            width: 70%;
            height: 70%;
            pointer-events: none;
        }

        .color-swatch:hover, .sticker-swatch:hover {
            transform: scale(1.1);
        }
        
        .color-swatch.selected, .sticker-swatch.selected {
            border-color: #000;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .sticker {
            position: absolute;
            width: 12.5%;
            height: 12.5%;
            pointer-events: auto;
            cursor: pointer;
        }

        .sticker svg {
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="title">ğŸ¨ ×œ×•××“×™× ×œ×›×ª×•×‘ ××•×ª×™×•×ª ×¢×‘×¨×™×ª</h1>
            <p class="subtitle">×‘×—×¨×• ××•×ª ×•×œ××“×• ××™×š ×›×•×ª×‘×™× ××•×ª×” × ×›×•×Ÿ!</p>
        </header>

        <main>
            <div id="lettersGrid" class="letters-grid"></div>

            <div id="practiceArea" class="practice-area">
                <button class="btn back-btn" onclick="goBack()">â† ×—×–×¨×” ×œ×‘×—×™×¨×ª ××•×ª×™×•×ª</button>
                
                <div class="practice-header">
                    <div id="letterDescription" class="letter-name" style="font-size: 1.5rem; font-weight: bold;"></div>
                     <div id="canvasContainer" class="canvas-container">
                        <canvas id="drawingCanvas"></canvas>
                        <div id="stickerContainer"></div>
                    </div>
                </div>
                
                <div class="controls">
                    <div class="mode-switcher">
                        <button id="drawModeBtn" class="mode-btn active" onclick="setMode('draw')">ğŸ¨ ××¦×‘ ×ª×œ××™×“ (×¦×™×•×¨)</button>
                        <button id="stickerModeBtn" class="mode-btn" onclick="setMode('sticker')">ğŸ“Œ ××¦×‘ ××•×¨×” (××“×‘×§×•×ª)</button>
                    </div>
                    <div id="colorPalette" class="palette"></div>
                    <div id="stickerPalette" class="palette" style="display: none;"></div>
                    <div class="action-buttons">
                        <button id="clearDrawingBtn" class="btn" onclick="clearDrawing()">ğŸ§¹ × ×§×” ×¦×™×•×¨</button>
                        <button id="clearStickersBtn" class="btn" onclick="clearStickers()">ğŸ—‘ï¸ × ×§×” ××“×‘×§×•×ª</button>
                        <button id="deleteStickerBtn" class="btn delete-mode" onclick="toggleDeleteStickerMode()">ğŸ—‘ï¸ ××—×§ ××“×‘×§×” ×‘×•×“×“×ª</button>
                        <button id="dragStickerBtn" class="btn drag-mode" onclick="toggleDragStickerMode()">âœ‹ ×’×¨×•×¨ ××“×‘×§×”</button>
                    </div>
                </div>

                <div id="instructions" class="instructions"></div>
            </div>
        </main>
    </div>

    <script>
        // --- Global variables and settings ---
        let currentLetterKey = '';
        let currentLetterName = '';
        let drawingCanvas, drawingCtx, stickerContainer;
        let isDrawing = false;
        let currentMode = 'draw';
        let deleteStickerMode = false;
        let dragStickerMode = false;
        let draggedSticker = null;
        let dragStartX, dragStartY;
        
        const drawingColors = ['#0055d4', '#d40000', '#008000', '#ffa500', '#800080', '#000000'];
        let currentColor = drawingColors[0];
        
        let selectedStickerType = null;

        const stickers = {
            start: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#4CAF50" stroke="#fff" stroke-width="5"/></svg>`,
            end: `<svg viewBox="0 0 100 100"><polygon points="50,5 61,35 95,35 67,55 78,85 50,65 22,85 33,55 5,35 39,35" fill="#F44336" stroke="#fff" stroke-width="5"/></svg>`,
            arrowN: `<svg viewBox="0 0 100 100"><path d="M50 90 L50 15 M30 35 L50 10 L70 35" stroke="#007bff" stroke-width="12" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
            arrowNE: `<svg viewBox="0 0 100 100"><path d="M20 80 L80 20 M60 15 L85 20 L80 40" stroke="#007bff" stroke-width="12" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
            arrowE: `<svg viewBox="0 0 100 100"><path d="M10 50 L85 50 M65 30 L90 50 L65 70" stroke="#007bff" stroke-width="12" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
            arrowSE: `<svg viewBox="0 0 100 100"><path d="M20 20 L80 80 M85 60 L80 85 L60 80" stroke="#007bff" stroke-width="12" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
            arrowS: `<svg viewBox="0 0 100 100"><path d="M50 10 L50 85 M30 65 L50 90 L70 65" stroke="#007bff" stroke-width="12" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
            arrowSW: `<svg viewBox="0 0 100 100"><path d="M80 20 L20 80 M15 60 L20 85 L40 80" stroke="#007bff" stroke-width="12" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
            arrowW: `<svg viewBox="0 0 100 100"><path d="M90 50 L15 50 M35 30 L10 50 L35 70" stroke="#007bff" stroke-width="12" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
            arrowNW: `<svg viewBox="0 0 100 100"><path d="M80 80 L20 20 M40 15 L15 20 L20 40" stroke="#007bff" stroke-width="12" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
            number1: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#FFD700" stroke="#000" stroke-width="5"/><text x="50" y="50" font-size="60" text-anchor="middle" dy=".3em" fill="#000">1</text></svg>`,
            number2: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#FFD700" stroke="#000" stroke-width="5"/><text x="50" y="50" font-size="60" text-anchor="middle" dy=".3em" fill="#000">2</text></svg>`,
            number3: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#FFD700" stroke="#000" stroke-width="5"/><text x="50" y="50" font-size="60" text-anchor="middle" dy=".3em" fill="#000">3</text></svg>`,
            number4: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#FFD700" stroke="#000" stroke-width="5"/><text x="50" y="50" font-size="60" text-anchor="middle" dy=".3em" fill="#000">4</text></svg>`,
            number5: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#FFD700" stroke="#000" stroke-width="5"/><text x="50" y="50" font-size="60" text-anchor="middle" dy=".3em" fill="#000">5</text></svg>`,
            number6: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#FFD700" stroke="#000" stroke-width="5"/><text x="50" y="50" font-size="60" text-anchor="middle" dy=".3em" fill="#000">6</text></svg>`,
            number7: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#FFD700" stroke="#000" stroke-width="5"/><text x="50" y="50" font-size="60" text-anchor="middle" dy=".3em" fill="#000">7</text></svg>`,
            number8: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#FFD700" stroke="#000" stroke-width="5"/><text x="50" y="50" font-size="60" text-anchor="middle" dy=".3em" fill="#000">8</text></svg>`
        };

        // --- Initialization ---
        function init() {
            createLetterGrid();
            setupCanvases();
            createColorPalette();
            createStickerPalette();
            setMode('draw');
            
            window.addEventListener('resize', () => {
                if (currentLetterKey) {
                    prepareDrawingCanvas();
                }
            });

            // ×××–×™× ×™× ×œ××—×™×§×” ×•×’×¨×™×¨×”
            stickerContainer.addEventListener('mousedown', handleStickerStart);
            stickerContainer.addEventListener('mousemove', handleStickerMove);
            stickerContainer.addEventListener('mouseup', handleStickerEnd);
            stickerContainer.addEventListener('touchstart', handleStickerStart, { passive: false });
            stickerContainer.addEventListener('touchmove', handleStickerMove, { passive: false });
            stickerContainer.addEventListener('touchend', handleStickerEnd);
        }
        
        function createLetterGrid() {
            const grid = document.getElementById('lettersGrid');
            grid.innerHTML = '';
            
            const lettersWithNames = [
                { char: '×', name: '××œ×£' }, { char: '×‘', name: '×‘×™×ª' }, { char: '×‘Ö¼', name: '×‘×™×ª ×“×’×•×©×”' },
                { char: '×’', name: '×’×™××œ' }, { char: '×“', name: '×“×œ×ª' }, { char: '×”', name: '×”×' },
                { char: '×•', name: '×•×•' }, { char: '×–', name: '×–×™×Ÿ' }, { char: '×—', name: '×—×™×ª' },
                { char: '×˜', name: '×˜×™×ª' }, { char: '×™', name: '×™×•×“' }, { char: '×›', name: '×›×£' },
                { char: '×›Ö¼', name: '×›×£ ×“×’×•×©×”' }, { char: '×š', name: '×›×£ ×¡×•×¤×™×ª' }, { char: '×œ', name: '×œ××“' },
                { char: '×', name: '××' }, { char: '×', name: '×× ×¡×•×¤×™×ª' }, { char: '× ', name: '× ×•×Ÿ' },
                { char: '×Ÿ', name: '× ×•×Ÿ ×¡×•×¤×™×ª' }, { char: '×¡', name: '×¡××š' }, { char: '×¢', name: '×¢×™×Ÿ' },
                { char: '×¤', name: '×¤×”' }, { char: '×¤Ö¼', name: '×¤×” ×“×’×•×©×”' }, { char: '×£', name: '×¤×” ×¡×•×¤×™×ª' },
                { char: '×¦', name: '×¦×“×™' }, { char: '×¥', name: '×¦×“×™ ×¡×•×¤×™×ª' }, { char: '×§', name: '×§×•×£' },
                { char: '×¨', name: '×¨×™×©' }, { char: '×©×‚', name: '×©×™×Ÿ ×©×××œ×™×ª' }, { char: '×©×', name: '×©×™×Ÿ ×™×× ×™×ª' },
                { char: '×ª', name: '×ª×•' }
            ];
            
            lettersWithNames.forEach(letterObj => {
                const card = document.createElement('div');
                card.className = 'letter-card';
                card.onclick = () => selectLetter(letterObj);
                card.innerHTML = `<div class="letter-display">${letterObj.char}</div><div class="letter-name">${letterObj.name}</div>`;
                grid.appendChild(card);
            });
        }

        function setupCanvases() {
            drawingCanvas = document.getElementById('drawingCanvas');
            drawingCtx = drawingCanvas.getContext('2d');
            stickerContainer = document.getElementById('stickerContainer');
        }

        function createColorPalette() {
            const palette = document.getElementById('colorPalette');
            palette.innerHTML = '';
            drawingColors.forEach((color, index) => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = color;
                if (index === 0) swatch.classList.add('selected');
                swatch.onclick = () => {
                    currentColor = color;
                    document.querySelector('.color-swatch.selected')?.classList.remove('selected');
                    swatch.classList.add('selected');
                };
                palette.appendChild(swatch);
            });
        }
        
        function createStickerPalette() {
            const palette = document.getElementById('stickerPalette');
            palette.innerHTML = '';
            Object.keys(stickers).forEach(key => {
                const swatch = document.createElement('div');
                swatch.className = 'sticker-swatch';
                swatch.innerHTML = stickers[key];
                swatch.dataset.stickerType = key;
                swatch.addEventListener('click', handleStickerSelect);
                palette.appendChild(swatch);
            });
        }

        // --- App State & Mode Management ---

        function selectLetter(letterObj) {
            currentLetterKey = letterObj.char;
            currentLetterName = letterObj.name;
            
            document.querySelectorAll('.letter-card.selected').forEach(c => c.classList.remove('selected'));
            const cards = document.querySelectorAll('.letter-card');
            cards.forEach(card => {
                if(card.querySelector('.letter-display').textContent === currentLetterKey) {
                    card.classList.add('selected');
                }
            });

            document.getElementById('lettersGrid').style.display = 'none';
            document.getElementById('practiceArea').classList.add('active');
            
            document.getElementById('letterDescription').textContent = `×ª×¨×’×•×œ ×›×ª×™×‘×ª ×”××•×ª: ${currentLetterName}`;
            
            prepareDrawingCanvas();
            clearStickers();
        }

        function goBack() {
            document.getElementById('practiceArea').classList.remove('active');
            document.getElementById('lettersGrid').style.display = 'grid';
            currentLetterKey = '';
            deleteStickerMode = false;
            dragStickerMode = false;
            updateDeleteButtonState();
            updateDragButtonState();
        }

        function setMode(mode) {
            currentMode = mode;
            const drawBtn = document.getElementById('drawModeBtn');
            const stickerBtn = document.getElementById('stickerModeBtn');
            const colorPalette = document.getElementById('colorPalette');
            const stickerPalette = document.getElementById('stickerPalette');
            const instructions = document.getElementById('instructions');

            if (mode === 'draw') {
                drawBtn.classList.add('active');
                stickerBtn.classList.remove('active');
                colorPalette.style.display = 'flex';
                stickerPalette.style.display = 'none';
                instructions.textContent = '×‘×—×¨×• ×¦×‘×¢ ×•×¦×™×™×¨×• ×‘×ª×•×š ×”××•×ª!';
            } else { // sticker mode
                drawBtn.classList.remove('active');
                stickerBtn.classList.add('active');
                colorPalette.style.display = 'none';
                stickerPalette.style.display = 'flex';
                instructions.textContent = '×œ×—×¦×• ×¢×œ ××“×‘×§×” ×œ×‘×—×™×¨×” ×•××– ×¢×œ ×”××•×ª ×œ×”×“×‘×§×”, ××• ×”×©×ª××©×• ×‘×›×¤×ª×•×¨×™× ×œ××—×™×§×” ××• ×’×¨×™×¨×ª ××“×‘×§×•×ª.';
                selectedStickerType = null;
                document.querySelector('.sticker-swatch.selected')?.classList.remove('selected');
            }
            deleteStickerMode = false;
            dragStickerMode = false;
            updateDeleteButtonState();
            updateDragButtonState();
        }

        // --- Canvas and Drawing ---

        function prepareDrawingCanvas() {
            if (!currentLetterKey) return;
            
            drawingCanvas.width = 400;
            drawingCanvas.height = 400;
            
            drawingCtx.globalCompositeOperation = 'source-over';
            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);

            const fontSize = 350;
            drawingCtx.font = `bold ${fontSize}px 'Suez One', serif`;
            drawingCtx.fillStyle = '#FFFFFF';
            drawingCtx.textAlign = 'center';
            drawingCtx.textBaseline = 'middle';
            const yOffset = ['×œ', '×§', '×š', '×Ÿ', '×£', '×¥'].includes(currentLetterKey) ? 0 : 20; 
            drawingCtx.fillText(currentLetterKey, drawingCanvas.width / 2, drawingCanvas.height / 2 + yOffset);
            
            drawingCtx.globalCompositeOperation = 'source-atop';
        }
        
        function clearDrawing() {
            prepareDrawingCanvas();
        }

        function clearStickers() {
            stickerContainer.innerHTML = '';
            deleteStickerMode = false;
            dragStickerMode = false;
            updateDeleteButtonState();
            updateDragButtonState();
        }

        function getEventCoords(e, element) {
            const rect = element.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const scaleX = drawingCanvas.width / rect.width;
            const scaleY = drawingCanvas.height / rect.height;
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        // --- Delete Sticker Mode ---
        function toggleDeleteStickerMode() {
            deleteStickerMode = !deleteStickerMode;
            dragStickerMode = false; // ×‘×˜×œ ××¦×‘ ×’×¨×™×¨×” ×× ×¤×¢×™×œ
            updateDeleteButtonState();
            updateDragButtonState();
            const instructions = document.getElementById('instructions');
            const canvasContainer = document.getElementById('canvasContainer');
            if (deleteStickerMode) {
                instructions.textContent = '×œ×—×¦×• ×¢×œ ××“×‘×§×•×ª ×œ××—×™×§×”. ×œ×—×¦×• ×©×•×‘ ×¢×œ ×”×›×¤×ª×•×¨ ×œ×‘×™×˜×•×œ.';
                canvasContainer.classList.add('delete-mode');
                canvasContainer.classList.remove('drag-mode');
            } else {
                instructions.textContent = currentMode === 'draw' ? 
                    '×‘×—×¨×• ×¦×‘×¢ ×•×¦×™×™×¨×• ×‘×ª×•×š ×”××•×ª!' : 
                    '×œ×—×¦×• ×¢×œ ××“×‘×§×” ×œ×‘×—×™×¨×” ×•××– ×¢×œ ×”××•×ª ×œ×”×“×‘×§×”, ××• ×”×©×ª××©×• ×‘×›×¤×ª×•×¨×™× ×œ××—×™×§×” ××• ×’×¨×™×¨×ª ××“×‘×§×•×ª.';
                canvasContainer.classList.remove('delete-mode');
            }
        }

        function updateDeleteButtonState() {
            const deleteBtn = document.getElementById('deleteStickerBtn');
            const canvasContainer = document.getElementById('canvasContainer');
            if (deleteStickerMode) {
                deleteBtn.classList.add('active');
                canvasContainer.classList.add('delete-mode');
            } else {
                deleteBtn.classList.remove('active');
                canvasContainer.classList.remove('delete-mode');
            }
        }

        function handleStickerDelete(e) {
            if (deleteStickerMode) {
                const sticker = e.target.closest('.sticker');
                if (sticker) {
                    sticker.remove();
                    const instructions = document.getElementById('instructions');
                    instructions.textContent = '×œ×—×¦×• ×¢×œ ××“×‘×§×•×ª ×œ××—×™×§×”. ×œ×—×¦×• ×©×•×‘ ×¢×œ ×”×›×¤×ª×•×¨ ×œ×‘×™×˜×•×œ.';
                }
            }
        }

        // --- Drag Sticker Mode ---
        function toggleDragStickerMode() {
            dragStickerMode = !dragStickerMode;
            deleteStickerMode = false; // ×‘×˜×œ ××¦×‘ ××—×™×§×” ×× ×¤×¢×™×œ
            updateDragButtonState();
            updateDeleteButtonState();
            const instructions = document.getElementById('instructions');
            const canvasContainer = document.getElementById('canvasContainer');
            if (dragStickerMode) {
                instructions.textContent = '×œ×—×¦×• ×•×’×¨×¨×• ××“×‘×§×•×ª ×œ××™×§×•× ×—×“×©. ×œ×—×¦×• ×©×•×‘ ×¢×œ ×”×›×¤×ª×•×¨ ×œ×‘×™×˜×•×œ.';
                canvasContainer.classList.add('drag-mode');
                canvasContainer.classList.remove('delete-mode');
            } else {
                instructions.textContent = currentMode === 'draw' ? 
                    '×‘×—×¨×• ×¦×‘×¢ ×•×¦×™×™×¨×• ×‘×ª×•×š ×”××•×ª!' : 
                    '×œ×—×¦×• ×¢×œ ××“×‘×§×” ×œ×‘×—×™×¨×” ×•××– ×¢×œ ×”××•×ª ×œ×”×“×‘×§×”, ××• ×”×©×ª××©×• ×‘×›×¤×ª×•×¨×™× ×œ××—×™×§×” ××• ×’×¨×™×¨×ª ××“×‘×§×•×ª.';
                canvasContainer.classList.remove('drag-mode');
            }
        }

        function updateDragButtonState() {
            const dragBtn = document.getElementById('dragStickerBtn');
            const canvasContainer = document.getElementById('canvasContainer');
            if (dragStickerMode) {
                dragBtn.classList.add('active');
                canvasContainer.classList.add('drag-mode');
            } else {
                dragBtn.classList.remove('active');
                canvasContainer.classList.remove('drag-mode');
            }
        }

        function handleStickerStart(e) {
            if (dragStickerMode) {
                const sticker = e.target.closest('.sticker');
                if (sticker) {
                    e.preventDefault();
                    draggedSticker = sticker;
                    const canvasRect = stickerContainer.getBoundingClientRect();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    dragStartX = clientX - canvasRect.left;
                    dragStartY = clientY - canvasRect.top;
                }
            } else if (deleteStickerMode) {
                handleStickerDelete(e);
            }
        }

        function handleStickerMove(e) {
            if (dragStickerMode && draggedSticker) {
                e.preventDefault();
                const canvasRect = stickerContainer.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                const percentX = ((clientX - canvasRect.left) / canvasRect.width) * 100;
                const percentY = ((clientY - canvasRect.top) / canvasRect.height) * 100;
                const stickerSizePercent = (50 / 400) * 100; // 50px sticker on 400px canvas

                draggedSticker.style.left = `${percentX - stickerSizePercent / 2}%`;
                draggedSticker.style.top = `${percentY - stickerSizePercent / 2}%`;
            }
        }

        function handleStickerEnd(e) {
            if (dragStickerMode && draggedSticker) {
                draggedSticker = null;
                const instructions = document.getElementById('instructions');
                instructions.textContent = '×œ×—×¦×• ×•×’×¨×¨×• ××“×‘×§×•×ª ×œ××™×§×•× ×—×“×©. ×œ×—×¦×• ×©×•×‘ ×¢×œ ×”×›×¤×ª×•×¨ ×œ×‘×™×˜×•×œ.';
            }
        }

        // --- Event Handlers for Student Drawing and Sticker Placement ---
        const drawingContainer = document.getElementById('canvasContainer');
        drawingContainer.addEventListener('mousedown', handleCanvasClick);
        drawingContainer.addEventListener('mousemove', (e) => { if (currentMode === 'draw') handleDrawMove(e); });
        drawingContainer.addEventListener('mouseup', (e) => { if (currentMode === 'draw') handleDrawEnd(e); });
        drawingContainer.addEventListener('mouseleave', (e) => { if (currentMode === 'draw') handleDrawEnd(e); });
        drawingContainer.addEventListener('touchstart', handleCanvasClick, { passive: false });
        drawingContainer.addEventListener('touchmove', (e) => { if (currentMode === 'draw') handleDrawMove(e); }, { passive: false });
        drawingContainer.addEventListener('touchend', (e) => { if (currentMode === 'draw') handleDrawEnd(e); });

        function handleCanvasClick(e) {
            if (deleteStickerMode || dragStickerMode) return; // ×œ× ×××¤×©×¨ ×”×“×‘×§×” ××• ×¦×™×•×¨ ×‘××¦×‘ ××—×™×§×” ××• ×’×¨×™×¨×”
            if (currentMode === 'draw') {
                handleDrawStart(e);
            } else if (currentMode === 'sticker' && selectedStickerType) {
                e.preventDefault();
                const canvasRect = drawingContainer.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                if (clientX > canvasRect.left && clientX < canvasRect.right &&
                    clientY > canvasRect.top && clientY < canvasRect.bottom) {
                    placeSticker(clientX, clientY, canvasRect);
                }
            }
        }

        function handleDrawStart(e) {
            e.preventDefault();
            isDrawing = true;
            const { x, y } = getEventCoords(e, drawingContainer);
            drawingCtx.strokeStyle = currentColor;
            drawingCtx.lineWidth = 25;
            drawingCtx.lineCap = 'round';
            drawingCtx.lineJoin = 'round';
            drawingCtx.beginPath();
            drawingCtx.moveTo(x, y);
        }
        function handleDrawMove(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const { x, y } = getEventCoords(e, drawingContainer);
            drawingCtx.lineTo(x, y);
            drawingCtx.stroke();
        }
        function handleDrawEnd() {
            if (!isDrawing) return;
            isDrawing = false;
            drawingCtx.closePath();
            document.getElementById('instructions').textContent = '× ×”×“×¨! ×œ×—×¦×• ×¢×œ "× ×§×”" ×›×“×™ ×œ× ×¡×•×ª ×©×•×‘.';
        }

        // --- Sticker Selection and Placement ---
        function handleStickerSelect(e) {
            selectedStickerType = e.currentTarget.dataset.stickerType;
            document.querySelector('.sticker-swatch.selected')?.classList.remove('selected');
            e.currentTarget.classList.add('selected');
            deleteStickerMode = false;
            dragStickerMode = false;
            updateDeleteButtonState();
            updateDragButtonState();
        }

        function placeSticker(clientX, clientY, canvasRect) {
            const percentX = ((clientX - canvasRect.left) / canvasRect.width) * 100;
            const percentY = ((clientY - canvasRect.top) / canvasRect.height) * 100;

            const stickerSizePercent = (50 / 400) * 100; // 50px sticker on 400px canvas

            const sticker = document.createElement('div');
            sticker.className = 'sticker';
            sticker.innerHTML = stickers[selectedStickerType];
            sticker.style.left = `${percentX - stickerSizePercent / 2}%`;
            sticker.style.top = `${percentY - stickerSizePercent / 2}%`;
            stickerContainer.appendChild(sticker);
        }
        
        // --- Run the App ---
        window.onload = init;
    </script>
</body>
</html>